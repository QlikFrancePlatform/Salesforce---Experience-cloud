<apex:page showHeader="false" sidebar="false" standardStylesheets="false">
    <apex:slds/>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f3f2f2;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .status-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        .success { color: #04844b; }
        .error { color: #c23934; }
        .loading { color: #0070d2; }
        .status-message {
            font-size: 18px;
            margin-bottom: 20px;
            color: #333;
        }
        .details {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
            text-align: left;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        .button {
            background-color: #0070d2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .button:hover {
            background-color: #005fb2;
        }
        .button.secondary {
            background-color: #706e6b;
        }
        .button.secondary:hover {
            background-color: #5a5a5a;
        }
    </style>
    
    <div class="container">
        <div id="loading" class="status-icon loading">⏳</div>
        <div id="success" class="status-icon success" style="display: none;">✅</div>
        <div id="error" class="status-icon error" style="display: none;">❌</div>
        
        <div id="loading-msg" class="status-message">Authentification en cours...</div>
        <div id="success-msg" class="status-message" style="display: none;">Authentification réussie !</div>
        <div id="error-msg" class="status-message" style="display: none;">Erreur d'authentification</div>
        
        <div id="details" class="details" style="display: none;">
            <strong>Détails de l'authentification :</strong><br/>
            <div id="auth-details"></div>
        </div>
        
        <div id="actions" style="display: none;">
            <button class="button" onclick="window.close()">Fermer cette fenêtre</button>
            <button class="button secondary" onclick="window.location.href='/apex/qlikEmbedPage'">Retour à Qlik Embed</button>
        </div>
    </div>

    <script type="text/javascript">
        // Parse URL parameters
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        // Handle OAuth callback
        function handleOAuthCallback() {
            const code = getUrlParameter('code');
            const state = getUrlParameter('state');
            const error = getUrlParameter('error');
            const errorDescription = getUrlParameter('error_description');
            
            console.log('OAuth Callback Parameters:', {
                code: code,
                state: state,
                error: error,
                errorDescription: errorDescription
            });
            
            if (error) {
                // Handle error
                showError(errorDescription || 'Erreur lors de l\'authentification');
                document.getElementById('auth-details').innerHTML = `
                    <strong>Erreur:</strong> ${error}<br/>
                    <strong>Description:</strong> ${errorDescription || 'Aucune description'}<br/>
                    <strong>State:</strong> ${state || 'Aucun state'}
                `;
            } else if (code) {
                // Handle success
                showSuccess();
                document.getElementById('auth-details').innerHTML = `
                    <strong>Code d'autorisation:</strong> ${code}<br/>
                    <strong>State:</strong> ${state || 'Aucun state'}<br/>
                    <strong>Timestamp:</strong> ${new Date().toLocaleString()}
                `;
                
                // Store the authorization code (you might want to send this to your backend)
                if (window.opener) {
                    // Send message to parent window
                    window.opener.postMessage({
                        type: 'QLIK_OAUTH_SUCCESS',
                        code: code,
                        state: state
                    }, '*');
                }
            } else {
                // No parameters found
                showError('Aucun paramètre d\'authentification trouvé');
                document.getElementById('auth-details').innerHTML = `
                    <strong>URL:</strong> ${window.location.href}<br/>
                    <strong>Timestamp:</strong> ${new Date().toLocaleString()}
                `;
            }
        }
        
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('success').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('loading-msg').style.display = 'block';
            document.getElementById('success-msg').style.display = 'none';
            document.getElementById('error-msg').style.display = 'none';
            document.getElementById('details').style.display = 'none';
            document.getElementById('actions').style.display = 'none';
        }
        
        function showSuccess() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('success').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('loading-msg').style.display = 'none';
            document.getElementById('success-msg').style.display = 'block';
            document.getElementById('error-msg').style.display = 'none';
            document.getElementById('details').style.display = 'block';
            document.getElementById('actions').style.display = 'block';
        }
        
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('success').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('loading-msg').style.display = 'none';
            document.getElementById('success-msg').style.display = 'none';
            document.getElementById('error-msg').style.display = 'block';
            document.getElementById('error-msg').textContent = message;
            document.getElementById('details').style.display = 'block';
            document.getElementById('actions').style.display = 'block';
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Simulate a small delay for better UX
            setTimeout(function() {
                handleOAuthCallback();
            }, 1000);
        });
        
        // Listen for messages from parent window
        window.addEventListener('message', function(event) {
            if (event.data.type === 'QLIK_OAUTH_REQUEST') {
                console.log('Received OAuth request from parent window');
            }
        });
    </script>
</apex:page>
